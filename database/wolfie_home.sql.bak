PRAGMA foreign_keys=OFF;
BEGIN TRANSACTION;
CREATE TABLE `User` (
    `Id` INTEGER PRIMARY KEY,
    `UserName` VARCHAR(30) NOT NULL,
    `Password` CHAR(128) NOT NULL,
    `Email` VARCHAR(40) NOT NULL DEFAULT "",
    `PassSalt` CHAR(8) NOT NULL,
    `CreatedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `ModifiedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (`UserName`)
);
INSERT INTO "User" VALUES(1,'kbumsik','e8589d6ac72a9ff13d88d6ce4d3f054b4279f6191da38768bf566a61e35e2593f9489b4dc4338a318c0c35843772d0c8a0ef1cf88161cca535c4a12fe9a17e5c','kbumsik@gmail.com','0pb3cps3','2016-09-15 02:10:38','2016-09-15 02:10:38');
CREATE TABLE `Location` (
    `Id` INTEGER PRIMARY KEY,
    `UserRef` UNSIGNED INTEGER NOT NULL,
    `Name` VARCHAR(20) NOT NULL,
    `Parent` UNSIGNED INTEGER,
    `Description` VARCHAR(50) NOT NULL DEFAULT "",
    `CreatedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `ModifiedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (`UserRef`, `Name`),
    FOREIGN KEY (`UserRef`) REFERENCES `User`(`Id`),
    FOREIGN KEY (`Parent`) REFERENCES `Location`(`Id`) ON DELETE SET NULL
);
CREATE TABLE `Device` (
    `Id` INTEGER PRIMARY KEY,
    `OwnerRef` UNSIGNED INTEGER NOT NULL,
    `Name` VARCHAR(20) NOT NULL,
    `LocationRef` UNSIGNED INTEGER,
    `Parent` UNSIGNED INTEGER,
    `Description` VARCHAR(50) NOT NULL DEFAULT "",
    `CreatedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `ModifiedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (`OwnerRef`, `Name`),
    FOREIGN KEY (`OwnerRef`) REFERENCES `User`(`Id`),
    FOREIGN KEY (`LocationRef`) REFERENCES `Location`(`Id`) ON DELETE  SET NULL,
    FOREIGN KEY (`Parent`) REFERENCES `Device`(`Id`) ON DELETE SET NULL
);
CREATE TABLE `DataType` (
    `Id` INTEGER PRIMARY KEY,
    `TypeName` VARCHAR(20) NOT NULL,
    `Description` VARCHAR(128) NOT NULL DEFAULT "",
    `CreatedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `ModifiedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (`TypeName`)
);
CREATE TABLE `DataField` (
    `Id` INTEGER PRIMARY KEY,
    `DeviceRef` UNSIGNED INTEGER NOT NULL,
    `DatafieldName` VARCHAR(16) NOT NULL,
    `Controllable` BOOLEAN NOT NULL,
    `DataTypeRef` UNSIGNED INTEGER NOT NULL,
    `Description` VARCHAR(50) NOT NULL DEFAULT "",
    `CreatedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `ModifiedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (`DeviceRef`, `DatafieldName`),
    FOREIGN KEY (`DataTypeRef`) REFERENCES `DataType`(`Id`),
    FOREIGN KEY (`DeviceRef`) REFERENCES `Device`(`OwnerRef`) ON DELETE CASCADE
);
CREATE TABLE `DataRecord` (
    `Id` INTEGER PRIMARY KEY ,
    `DeviceRef` UNSIGNED INTEGER NOT NULL,
    `LocationRef` UNSIGNED INTEGER,
    `CreatedTime` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (`LocationRef`) REFERENCES `Location`(`Id`),
    FOREIGN KEY (`DeviceRef`) REFERENCES `Device`(`Id`)
);
CREATE TABLE `RecordFieldValue` (
    `Id` INTEGER PRIMARY KEY ,
    `RecordRef` UNSIGNED BIGINT NOT NULL,
    `DataFieldRef` UNSIGNED INTEGER NOT NULL,
    `Value` VARCHAR(30) NOT NULL,
    FOREIGN KEY (`RecordRef`) REFERENCES `DataRecord`(`Idx`) ON DELETE CASCADE,
    FOREIGN KEY (`DataFieldRef`) REFERENCES `DataField`(`Id`)
);
COMMIT;
